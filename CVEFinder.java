import org.junit.Test;
import org.openqa.selenium.By;
import org.openqa.selenium.WebElement;
import setup.Browser;

import java.io.IOException;
import java.nio.charset.Charset;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.nio.file.StandardOpenOption;
import java.util.LinkedList;
import java.util.List;

import static util.Globals.OPEN_SOURCE_LIST;

/**
 * @author rakibamin
 * @since 4/17/2018
 */
public class CVEFinder {

    final String CVE_URL = "http://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=";

    @Test
    public void test_CVE() {

        Browser browser = new Browser("chrome");
        List<String> scrapedData = new LinkedList<>();

        try {

            for (String keyword : OPEN_SOURCE_LIST) {

                browser.getDriver().get(CVE_URL + keyword.split(":")[0]);

                try {
                    
                    scrapedData.add("<h5>" + keyword + "</h5>");
                    
                    for (WebElement webElement : browser.getDriver().findElement(By.id("TableWithRules")).findElements(By.tagName("td"))) {
                        
                        if (webElement.getText().contains("CVE")) {
                            scrapedData.add("<a target = \"_blank\" href=\"https://nvd.nist.gov/vuln/detail/");
                            scrapedData.add(webElement.getText() + "\">");
                            scrapedData.add(webElement.getText());
                            scrapedData.add("</a>");
                        } else {
                            scrapedData.add("<p>" + webElement.getText() + "</p>");
                        }
                    }
                } catch (Exception e) {
                    continue;
                }

                scrapedData.add("<br>");

            }

            Files.write(Files.createFile(Paths.get("cve.html")), scrapedData, Charset.forName("UTF-8"), StandardOpenOption.CREATE);

        } catch (IOException ioe) {
            ioe.printStackTrace();
        }

        browser.getDriver().close();

    }
}
